# Git文件同步系统 - 伪代码说明

## 系统概述
这是一个智能的Git文件同步系统，能够将本地Git仓库的增量变更实时同步到远程服务器，支持初始完整同步和后续增量同步。

## 核心组件

### 1. 主服务脚本 (sync-files.sh)
```
程序 主同步服务():
    初始化配置()
    显示配置信息()
    开始主循环():
        加载配置()
        执行文件同步()
        等待刷新间隔()
```

### 2. 远程助手脚本 (remote-sync-helper.sh)
```
程序 远程助手():
    接收命令参数()
    根据命令类型执行:
        检查仓库存在性()
        初始化仓库()
        版本同步()
        强制重置()
```

### 3. 服务管理脚本 (sync-service.sh)
```
程序 服务管理():
    解析命令参数()
    执行对应操作:
        安装systemd服务()
        启动/停止/重启服务()
        查看状态和日志()
```

## 详细算法流程

### 配置管理算法
```
函数 加载配置():
    如果 配置文件不存在:
        使用默认配置
        返回
    
    获取配置文件时间戳
    如果 有缓存 且 时间戳一致:
        加载缓存配置
        返回
    
    解析YAML配置文件:
        初始化解析状态标志
        逐行读取配置文件:
            识别配置段落(remote/directories/exclude_patterns)
            解析键值对
            填充配置数组
    
    验证配置完整性()
    保存配置缓存()
```

### 文件同步核心算法
```
函数 同步文件():
    对于每个本地目录:
        检查目录有效性()
        检查是否为Git仓库()
        
        确保远程脚本已上传()
        
        检查远程项目状态 = SSH执行("检查仓库存在性")
        
        如果 远程项目不存在:
            执行初始完整同步()
            继续下一个目录
        
        获取本地Git状态:
            当前分支 = git branch --show-current
            远程分支 = "origin/" + 当前分支
            
        检查变更情况:
            未推送提交数 = git rev-list --count 远程分支..HEAD
            未提交变更 = git diff检查结果
            
        如果 无变更:
            执行远程版本更新()
            继续下一个目录
            
        收集需要同步的文件:
            修改文件 = git diff --name-only
            暂存文件 = git diff --cached --name-only  
            未跟踪文件 = git ls-files --others --exclude-standard
            未推送文件 = git diff --name-only 远程分支..HEAD
            
        合并去重文件列表()
        
        如果 有文件需要同步:
            显示同步统计信息()
            执行远程版本同步()
            执行rsync文件传输()
```

### 初始同步算法
```
函数 执行初始完整同步(本地目录, 远程目录, 目录名):
    创建临时压缩文件()
    
    压缩项目文件:
        排除.git目录
        排除配置的排除模式
        使用tar.gz格式压缩
        
    如果 压缩成功:
        创建远程目录
        传输压缩包到远程
        
        如果 传输成功:
            远程解压文件
            删除压缩包
            初始化远程Git仓库
            返回成功
        否则:
            返回传输失败
    否则:
        返回压缩失败
```

### 远程版本同步算法
```
函数 更新远程仓库(远程目录, 目录名, 保留文件列表, 本地哈希, 本地分支):
    确保远程脚本可用()
    
    准备排除模式参数()
    
    执行远程版本同步 = SSH调用远程脚本:
        传递参数(远程目录, 保留文件, 本地哈希, 本地分支, 排除模式)
        
    解析同步结果:
        提取远程状态信息
        提取同步状态码
        处理错误信息
        
    根据状态码显示结果:
        HASH_MATCH: 静默跳过(版本已同步)
        REMOTE_NEWER: 显示远程版本更新
        PULLING_TO_LOCAL_HASH: 显示已更新到本地版本
        错误状态: 显示同步失败信息
```

### 远程助手核心算法
```
函数 远程版本同步(目标目录, 保留文件列表, 本地哈希, 本地分支, 排除模式):
    切换到目标目录()
    
    如果 不是Git仓库:
        返回 NOT_GIT_REPO
        
    获取远程Git状态:
        远程分支 = git branch --show-current
        远程哈希 = git rev-parse HEAD
        
    输出远程状态信息()
    
    如果 远程哈希 == 本地哈希:
        返回 HASH_MATCH
        
    检查远程origin配置:
        如果 无远程origin:
            返回 NO_REMOTE_ORIGIN
            
    分支处理逻辑:
        如果 远程分支 != 本地分支:
            切换到本地分支
            强制重置到本地哈希
            返回 BRANCH_MISMATCH_SWITCHING
            
        如果 本地哈希不存在于远程:
            返回 HASH_NOT_FOUND
            
        比较版本新旧:
            如果 远程比本地新:
                返回 REMOTE_NEWER
            否则:
                拉取到本地哈希版本
                返回 PULLING_TO_LOCAL_HASH
                
    执行智能文件回滚:
        获取所有文件列表
        计算需要回滚的文件 = 全部文件 - 保留文件 - 排除文件
        回滚不需要的文件
```

### 强制重置算法
```
函数 强制重置到哈希(目标哈希):
    静默清理Git状态:
        中止merge/rebase/cherry-pick操作
        取消暂存文件
        强制回滚修改文件
        删除未跟踪文件
        
    尝试标准重置:
        如果 git reset --hard 目标哈希 成功:
            返回成功
            
    尝试激进重置:
        删除Git索引文件
        强制检出到目标哈希
        重新关联分支(如果需要)
        
        如果 成功:
            返回成功
        否则:
            返回 RESET_FAILED
```

### rsync文件传输算法
```
函数 rsync同步文件(文件列表, 本地目录, 远程目标):
    构建rsync参数:
        对于每个文件:
            添加 --include=文件路径
            添加父目录的include规则
        添加 --exclude=* (排除其他所有文件)
        
    构建完整rsync命令:
        rsync -avz [include参数] [exclude参数] -e "ssh -p 端口" 本地/ 远程/
        
    静默执行rsync:
        如果 成功:
            显示"文件已同步"
        否则:
            显示"同步失败"
```

### 远程脚本管理算法
```
函数 确保远程脚本():
    如果 已确认存在标志为真:
        返回成功
        
    检查远程脚本是否存在且可执行:
        SSH执行 "[ -x /tmp/remote-sync-helper.sh ]"
        
    如果 远程脚本存在:
        设置已确认存在标志
        返回成功
        
    如果 远程脚本不存在:
        检查本地脚本存在性()
        上传脚本到远程:
            使用scp传输脚本文件
            设置远程脚本执行权限
            
        如果 上传成功:
            设置已确认存在标志
            返回成功
        否则:
            返回失败

安装时脚本上传流程:
    解析配置文件获取远程服务器信息
    测试SSH连接可用性
    上传remote-sync-helper.sh到/tmp/目录
    设置远程脚本执行权限
    记录上传状态供后续使用
```

## 服务管理流程

### systemd服务安装
```
函数 安装同步服务():
    检查sudo权限()
    
    创建systemd服务文件:
        设置服务描述和依赖
        配置用户和工作目录
        设置重启策略
        配置日志输出
        
    设置脚本执行权限()
    重新加载systemd配置()
    启用开机自启动()
```

### 服务状态管理
```
函数 服务操作(操作类型):
    根据操作类型:
        启动: systemctl start 服务名
        停止: systemctl stop 服务名
        重启: systemctl restart 服务名
        状态: systemctl status 服务名
        
    记录操作日志()
    显示操作结果()
```

## 错误处理机制

### 网络错误处理
```
函数 网络操作重试(操作函数, 最大重试次数):
    重试计数 = 0
    当 重试计数 < 最大重试次数:
        尝试执行操作
        如果 成功:
            返回成功
        否则:
            重试计数++
            等待重试间隔
    返回失败
```

### Git冲突处理
```
函数 处理Git冲突():
    检测冲突类型:
        merge冲突
        rebase冲突
        文件锁定
        
    采用分层重置策略:
        1. 温和重置(取消操作, 回滚修改)
        2. 激进重置(删除索引, 强制检出)
        3. 分支重建(重新创建分支)
```

## 性能优化策略

### 缓存机制
```
配置缓存:
    - 时间戳比较避免重复解析
    - 内存缓存配置项
    - 文件缓存持久化

远程脚本缓存:
    - 检查远程脚本存在性
    - 避免重复上传
    - 版本一致性检查
```

### 网络优化
```
传输优化:
    - 初始同步使用压缩传输
    - 增量同步只传输变更文件
    - rsync增量算法
    - SSH连接复用
```

### 文件过滤优化
```
智能过滤:
    - 预定义排除模式
    - 动态文件状态检测
    - 重复文件去重
    - 目录层级优化
```

## 监控和日志

### 日志记录策略
```
日志级别:
    - 错误: 关键错误信息
    - 警告: 重要状态变化
    - 信息: 同步操作结果
    - 调试: 详细执行过程(已优化删除)
```

### 状态监控
```
监控指标:
    - 同步成功率
    - 文件传输量
    - 错误频率
    - 服务运行时间
```

这个伪代码说明展示了整个Git同步系统的核心算法和工作流程，帮助理解系统的设计思路和实现细节。 