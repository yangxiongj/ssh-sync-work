# WSL Ubuntu Git增量同步服务使用说明

## 前置准备

### 1. 启用 WSL systemd 支持

在WSL Ubuntu中执行：

```bash
# 编辑WSL配置文件
sudo nano /etc/wsl.conf

# 添加以下内容
[boot]
systemd=true
```

然后在Windows PowerShell中重启WSL：
```powershell
wsl --shutdown
```

### 2. 安装必要依赖

在WSL Ubuntu中执行：
```bash
# 更新包列表
sudo apt update

# 安装Git、rsync和SSH客户端
sudo apt install git rsync openssh-client
```

### 3. 配置SSH密钥认证

```bash
# 生成SSH密钥（如果还没有）
ssh-keygen -t rsa -b 4096

# 将公钥复制到远程服务器
ssh-copy-id user@your-server-ip
```

## 使用步骤

### 1. 复制脚本到WSL

将项目文件复制到WSL Ubuntu中：

```bash
# 在WSL中创建工作目录
mkdir -p ~/file-sync
cd ~/file-sync

# 从Windows目录复制文件（假设项目在D:\PycharmProjects\test2）
cp /mnt/d/PycharmProjects/test2/*.sh .
cp /mnt/d/PycharmProjects/test2/README.md .
```

### 2. 设置脚本权限

```bash
# 给脚本添加执行权限
chmod +x sync-files.sh sync-service.sh install.sh
```

### 3. 配置同步参数

编辑 `sync-files.sh` 文件：

```bash
nano sync-files.sh
```

修改以下配置：
```bash
# 基础配置
REMOTE_HOST="你的服务器IP"
REMOTE_PORT="22"
LOCAL_DIRS=(
    "/mnt/d/PycharmProjects/searxng"        # Windows D:\PycharmProjects\searxng (必须是Git仓库)
    "/mnt/d/PycharmProjects/fast-crawler"   # Windows D:\PycharmProjects\fast-crawler (必须是Git仓库)
)
REMOTE_DIR="/root/work"
REFRESH_INTERVAL=60
```

**重要：** 确保所有配置的目录都是Git仓库，否则会被跳过同步。

**行结束符配置：**
```bash
# Git配置
AUTO_CRLF_CONFIG=true  # 自动处理CRLF/LF转换问题
```

### 4. 测试连接

```bash
# 测试SSH连接
ssh your-username@your-server-ip -p 22

# 测试rsync命令
rsync --version
```

### 5. 运行安装脚本

```bash
# 运行一键安装
./install.sh
```

或者手动安装：

```bash
# 安装服务
sudo ./sync-service.sh install

# 启动服务
./sync-service.sh start

# 查看状态
./sync-service.sh status
```

## 常用命令

```bash
# 查看服务状态
./sync-service.sh status

# 启动服务
./sync-service.sh start

# 停止服务
./sync-service.sh stop

# 重启服务
./sync-service.sh restart

# 查看日志
./sync-service.sh logs

# 实时查看日志
./sync-service.sh logs-f

# 卸载服务
sudo ./sync-service.sh uninstall
```

## 路径映射说明

Windows路径 → WSL路径：
- `C:\Users\` → `/mnt/c/Users/`
- `D:\PycharmProjects\` → `/mnt/d/PycharmProjects/`
- `E:\Data\` → `/mnt/e/Data/`

## 故障排除

### 1. WSL不支持systemd

如果遇到systemd相关错误：
```bash
# 检查systemd状态
systemctl --version

# 如果不支持，需要启用WSL systemd支持（见前置准备）
```

### 2. 权限问题

```bash
# 确保脚本有执行权限
ls -la *.sh

# 如果没有执行权限，添加权限
chmod +x *.sh
```

### 3. SSH连接问题

```bash
# 测试SSH连接
ssh -v your-username@your-server-ip

# 检查SSH密钥
ls -la ~/.ssh/
```

### 4. 路径问题

```bash
# 检查Windows目录是否正确挂载
ls -la /mnt/d/PycharmProjects/
```

## 服务管理

### systemd命令

```bash
# 查看服务状态
systemctl status file-sync-service

# 查看服务日志
journalctl -u file-sync-service -f

# 手动启动/停止
sudo systemctl start file-sync-service
sudo systemctl stop file-sync-service

# 启用/禁用开机自启
sudo systemctl enable file-sync-service
sudo systemctl disable file-sync-service
```

### 日志文件

```bash
# 查看同步日志
tail -f service.log

# 查看系统日志
journalctl -u file-sync-service --since "1 hour ago"
```

## Git增量同步说明

### 工作原理
1. **只同步Git仓库** - 非Git目录会被自动跳过
2. **智能同步模式**：
   - **初始同步** - 远程项目不存在时，压缩整个项目传输
   - **增量同步** - 远程项目存在时，只传输变化的文件
3. **检测需要同步的更改** - 包括：
   - 未推送到远程分支的提交中的文件
   - 未提交的修改、暂存和未跟踪文件
4. **远程自动更新** - 在增量同步前自动拉取最新版本
5. **高效传输** - 初始同步使用压缩包，增量同步只传输变化文件

### 同步条件
- 目录必须是Git仓库（包含.git文件夹）
- 必须满足以下任一条件：
  - 有未推送到远程分支的提交
  - 有未提交的更改（修改、新增、删除文件）
- 既无未推送提交又无未提交更改的仓库会被跳过

### 同步流程详解

#### 初始同步流程（远程项目不存在）
```bash
# 1. 创建压缩包（排除.git和配置的排除项）
tar -czf project.tar.gz --exclude='.git' --exclude='node_modules' ...

# 2. 传输到远程服务器
scp project.tar.gz remote_server:/path/to/project/

# 3. 远程解压并初始化
cd /path/to/project/
tar -xzf project.tar.gz
rm project.tar.gz
git init
git add .
git commit -m 'Initial commit from sync service'
```

#### 增量同步流程（远程项目已存在）
每次增量同步前，远程服务器会自动执行：
```bash
git checkout .      # 回滚本地修改
git clean -fd       # 清理未跟踪文件  
git pull origin     # 拉取最新版本
```

## 注意事项

1. **确保WSL支持systemd** - 这是服务正常运行的前提
2. **配置SSH密钥认证** - 避免同步时需要输入密码
3. **检查网络连接** - 确保能够访问远程服务器
4. **验证路径映射** - 确认Windows路径在WSL中的映射正确
5. **确保目录是Git仓库** - 非Git目录不会被同步
6. **定期检查日志** - 及时发现和解决同步问题
7. **行结束符配置** - 脚本会自动处理CRLF/LF转换问题 